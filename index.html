<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        pre { background: #1f2937; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; color: #e5e7eb; }
        .modal-overlay { background: rgba(0,0,0,0.7); display: none; }
        .modal-overlay.active { display: flex; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex overflow-hidden">

    <aside id="sidebar" class="w-72 bg-gray-800 flex flex-col border-r border-gray-700 transition-all duration-300">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
            <button onclick="createNewChat()" class="flex-1 mr-2 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition">
                <i class="fas fa-plus text-xs"></i> New Chat
            </button>
            <button onclick="toggleSettings()" class="p-2 hover:bg-gray-700 rounded-lg text-gray-400">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        
        <div id="chat-history" class="flex-1 overflow-y-auto p-2 space-y-1">
            </div>

        <div class="p-4 border-t border-gray-700">
            <button onclick="exportAllChats()" class="w-full text-sm text-gray-400 hover:text-white flex items-center gap-2 mb-2">
                <i class="fas fa-download"></i> Export History (HTML)
            </button>
            <button onclick="clearAllHistory()" class="w-full text-sm text-red-400 hover:text-red-300 flex items-center gap-2">
                <i class="fas fa-trash"></i> Clear All History
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <header class="p-4 border-b border-gray-700 bg-gray-800 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <button id="toggleSidebar" class="p-2 hover:bg-gray-700 rounded-lg lg:hidden">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="font-bold text-lg hidden sm:block">Universal AI</h1>
            </div>
            
            <div class="flex gap-2">
                <select id="modelSelect" class="bg-gray-700 border border-gray-600 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 max-w-[200px]">
                    <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="google/gemini-pro">Gemini Pro</option>
                    <option value="meta-llama/llama-3-70b-instruct">Llama 3 70B</option>
                </select>
                <button onclick="fetchModels()" class="text-xs text-blue-400 hover:underline">Refresh List</button>
            </div>
        </header>

        <div id="chatWindow" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 chat-container">
            <div class="text-center text-gray-500 mt-20">
                <i class="fas fa-robot text-5xl mb-4"></i>
                <p>Welcome. Select a model and start chatting.</p>
            </div>
        </div>

        <div class="p-4 md:p-8 border-t border-gray-700 bg-gray-900">
            <form id="chatForm" class="max-w-4xl mx-auto relative">
                <textarea id="userInput" rows="1" class="w-full bg-gray-800 border border-gray-700 rounded-xl py-3 pl-4 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" placeholder="Message AI..."></textarea>
                <button type="submit" class="absolute right-3 bottom-3 p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
            <p class="text-center text-xs text-gray-500 mt-2">API keys are stored locally in your browser.</p>
        </div>
    </main>

    <div id="settingsModal" class="modal-overlay fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Settings</h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">OpenRouter API Key</label>
                    <input type="password" id="openrouterKey" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">OpenAI API Key</label>
                    <input type="password" id="openaiKey" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Gemini API Key</label>
                    <input type="password" id="geminiKey" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button onclick="saveSettings()" class="w-full bg-blue-600 py-2 rounded-lg font-bold hover:bg-blue-700 transition mt-4">Save Config</button>
            </div>
        </div>
    </div>

    <script>
        let chats = JSON.parse(localStorage.getItem('ai_chats') || '[]');
        let currentChatId = null;
        let config = JSON.parse(localStorage.getItem('ai_config') || '{"openrouter":"","openai":"","gemini":"","lastModel":"openai/gpt-3.5-turbo"}');

        // Initialization
        window.onload = () => {
            document.getElementById('openrouterKey').value = config.openrouter || '';
            document.getElementById('openaiKey').value = config.openai || '';
            document.getElementById('geminiKey').value = config.gemini || '';
            document.getElementById('modelSelect').value = config.lastModel || 'openai/gpt-3.5-turbo';
            renderHistory();
            if (chats.length > 0) loadChat(chats[0].id);
            else createNewChat();
        };

        // --- Core Chat Functions ---
        async function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message || !config.openrouter) {
                if(!config.openrouter) alert("Please set your OpenRouter API Key in settings first!");
                return;
            }

            const model = document.getElementById('modelSelect').value;
            addMessageToUI('user', message);
            input.value = '';
            input.style.height = 'auto';

            const chatIndex = chats.findIndex(c => c.id === currentChatId);
            chats[chatIndex].messages.push({ role: 'user', content: message });
            
            const loadingId = addMessageToUI('ai', 'Thinking...');

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${config.openrouter}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: chats[chatIndex].messages
                    })
                });
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                document.getElementById(loadingId).innerHTML = formatMarkdown(aiResponse);
                chats[chatIndex].messages.push({ role: 'assistant', content: aiResponse });
                
                // Update title if it's the first message
                if (chats[chatIndex].messages.length === 2) {
                    chats[chatIndex].title = message.substring(0, 30) + '...';
                }
                
                saveData();
                renderHistory();
            } catch (err) {
                document.getElementById(loadingId).innerText = "Error: " + err.message;
            }
        }

        function createNewChat() {
            const id = Date.now();
            chats.unshift({ id, title: 'New Conversation', messages: [] });
            currentChatId = id;
            saveData();
            renderHistory();
            loadChat(id);
        }

        function loadChat(id) {
            currentChatId = id;
            const chat = chats.find(c => c.id === id);
            const window = document.getElementById('chatWindow');
            window.innerHTML = '';
            chat.messages.forEach(m => addMessageToUI(m.role === 'user' ? 'user' : 'ai', m.content));
            renderHistory();
        }

        function deleteChat(id, e) {
            e.stopPropagation();
            chats = chats.filter(c => c.id !== id);
            if (currentChatId === id) currentChatId = chats.length > 0 ? chats[0].id : null;
            if (!currentChatId) createNewChat();
            saveData();
            renderHistory();
            loadChat(currentChatId);
        }

        // --- UI Utilities ---
        function addMessageToUI(role, text) {
            const window = document.getElementById('chatWindow');
            const id = 'msg-' + Date.now();
            const isUser = role === 'user';
            
            const msgHtml = `
                <div class="flex ${isUser ? 'justify-end' : 'justify-start'} animate-fadeIn">
                    <div class="max-w-[85%] p-4 rounded-2xl ${isUser ? 'bg-blue-600' : 'bg-gray-800 border border-gray-700 shadow-sm'}">
                        <p class="text-xs font-bold mb-1 opacity-50 uppercase">${role}</p>
                        <div id="${id}" class="prose prose-invert">${isUser ? text : formatMarkdown(text)}</div>
                    </div>
                </div>
            `;
            window.insertAdjacentHTML('beforeend', msgHtml);
            window.scrollTo({ top: window.scrollHeight, behavior: 'smooth' });
            return id;
        }

        function renderHistory() {
            const container = document.getElementById('chatHistory'); // Corrected typo from 'chat-history'
            const list = document.getElementById('chat-history');
            list.innerHTML = chats.map(chat => `
                <div onclick="loadChat(${chat.id})" class="group flex justify-between items-center p-3 rounded-lg cursor-pointer transition ${currentChatId === chat.id ? 'bg-gray-700' : 'hover:bg-gray-800'}">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="far fa-comment text-gray-500"></i>
                        <span class="truncate text-sm">${chat.title}</span>
                    </div>
                    <button onclick="deleteChat(${chat.id}, event)" class="opacity-0 group-hover:opacity-100 p-1 text-gray-500 hover:text-red-400">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        // --- Settings & API ---
        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('active');
        }

        function saveSettings() {
            config.openrouter = document.getElementById('openrouterKey').value;
            config.openai = document.getElementById('openaiKey').value;
            config.gemini = document.getElementById('geminiKey').value;
            config.lastModel = document.getElementById('modelSelect').value;
            localStorage.setItem('ai_config', JSON.stringify(config));
            toggleSettings();
            alert("Settings Saved Locally.");
        }

        async function fetchModels() {
            if (!config.openrouter) return alert("Key needed to fetch models.");
            try {
                const res = await fetch("https://openrouter.ai/api/v1/models");
                const { data } = await res.json();
                const select = document.getElementById('modelSelect');
                select.innerHTML = data.slice(0, 50).map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            } catch (e) { console.error(e); }
        }

        function exportAllChats() {
            const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-backup-${new Date().toISOString().slice(0,10)}.html`;
            a.click();
        }

        function clearAllHistory() {
            if(confirm("Wipe all chats? This cannot be undone.")) {
                chats = [];
                localStorage.removeItem('ai_chats');
                createNewChat();
            }
        }

        function saveData() {
            localStorage.setItem('ai_chats', JSON.stringify(chats));
        }

        // Helper for basic markdown-style formatting
        function formatMarkdown(text) {
            return text
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code class="bg-gray-700 px-1 rounded">$1</code>')
                .replace(/\n/g, '<br>');
        }

        // Auto-resize textarea
        document.getElementById('userInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        document.getElementById('chatForm').onsubmit = sendMessage;
    </script>
</body>
</html>
